<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEON DASH - Music Edition</title>
    <style>
        :root {
            --neon-blue: #00f2ff;
            --neon-pink: #ff00de;
            --neon-gold: #ffcc00;
            --neon-slow: #00ff88;
            --bg-color: #0a0a0c;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: var(--bg-color);
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            touch-action: none;
            color: white;
        }

        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        canvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            box-sizing: border-box;
            z-index: 5;
        }

        #score {
            font-size: 3rem;
            font-weight: 900;
            text-shadow: 0 0 15px var(--neon-blue);
            margin: 0;
            text-align: center;
        }

        #level-indicator {
            font-size: 1rem;
            color: var(--neon-blue);
            letter-spacing: 2px;
            text-align: center;
        }

        #combo {
            font-size: 1.2rem;
            color: var(--neon-pink);
            font-weight: bold;
            opacity: 0;
            text-align: center;
            transition: opacity 0.2s;
        }

        #combo.active {
            opacity: 1;
        }

        #slow-gauge-container {
            position: absolute;
            bottom: 30%;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            opacity: 0;
            transition: opacity 0.3s;
        }

        #slow-gauge {
            width: 100%;
            height: 100%;
            background: var(--neon-slow);
            box-shadow: 0 0 10px var(--neon-slow);
            transform-origin: left;
        }

        #slow-gauge-container.active {
            opacity: 1;
        }

        #overlay-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 12, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            pointer-events: auto;
            z-index: 100;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }

        h1 {
            font-size: 3rem;
            margin: 0 0 10px;
            background: linear-gradient(to right, var(--neon-blue), var(--neon-pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-transform: uppercase;
            font-style: italic;
        }

        input[type="text"] {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid var(--neon-blue);
            color: white;
            padding: 10px;
            font-size: 1.2rem;
            border-radius: 5px;
            width: 200px;
            text-align: center;
            margin-bottom: 20px;
            outline: none;
        }

        .btn {
            padding: 15px 40px;
            font-size: 1.2rem;
            background: transparent;
            color: white;
            border: 2px solid var(--neon-blue);
            border-radius: 5px;
            cursor: pointer;
            text-transform: uppercase;
            font-weight: bold;
            transition: 0.2s;
        }

        .btn:hover {
            background: var(--neon-blue);
            color: black;
            box-shadow: 0 0 20px var(--neon-blue);
        }

        #leaderboard {
            width: 100%;
            max-width: 300px;
            margin: 20px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            font-size: 0.85rem;
        }

        .leaderboard-entry {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .is-me {
            color: var(--neon-blue);
            font-weight: bold;
        }

        #msg-overlay {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3.5rem;
            font-weight: 900;
            color: white;
            text-shadow: 0 0 20px var(--neon-pink);
            pointer-events: none;
            opacity: 0;
            z-index: 50;
        }

        @keyframes popOut {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }

            20% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.2);
            }

            80% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.0);
            }

            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(1.5);
            }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>

        <div id="ui-layer">
            <div>
                <div id="level-indicator">LEVEL 1</div>
                <div id="score">0</div>
                <div id="combo">NEAR MISS x1</div>
            </div>
            <div id="slow-gauge-container">
                <div id="slow-gauge"></div>
            </div>
        </div>

        <div id="msg-overlay">READY...</div>

        <div id="overlay-screen">
            <h1 id="screen-title">NEON DASH</h1>
            <p id="screen-subtitle" style="color:#aaa; font-size: 0.8rem; margin-bottom: 20px;">名前を入力してスタート</p>

            <input type="text" id="player-name" placeholder="YOUR NAME" maxlength="10">

            <div id="leaderboard" class="hidden">
                <div style="font-weight: bold; margin-bottom: 10px; color: var(--neon-gold);">GLOBAL RANKING</div>
                <div id="leaderboard-list">Loading...</div>
            </div>

            <button id="main-button" class="btn">START GAME</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, limit, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- Firebase設定 ---
        let firebaseConfig;
        try {
            firebaseConfig = JSON.parse(__firebase_config);
        } catch (e) {
            firebaseConfig = {
                apiKey: "AIzaSyBpnRNS5MDXn6_3PuWsYlUZs6Kl-SJAlko",
                authDomain: "neon-dash-db.firebaseapp.com",
                projectId: "neon-dash-db",
                storageBucket: "neon-dash-db.firebasestorage.app",
                messagingSenderId: "205106729402",
                appId: "1:205106729402:web:20b827387f1c0e24444d83"
            };
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'neon-dash-v3';

        let user = null;
        const authenticate = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };
        onAuthStateChanged(auth, (u) => {
            user = u;
            if (u) loadRanking();
        });
        authenticate();

        // --- Sound Setup ---
        // 安定した音源（または無音に近い短いループ）に変更、あるいはエラーハンドリングを強化
        const bgm = new Audio('https://actions.google.com/sounds/v1/science_fiction/scifi_loop.ogg'); // Example Google sound
        bgm.loop = true;
        bgm.volume = 0.3;

        // エラーハンドリング: 再生できなくてもアプリを止めない
        bgm.onerror = () => {
            console.warn("BGM load failed. Proceeding without audio.");
            // ダミーオブジェクトにしてエラーを防ぐ
            bgm.play = () => Promise.resolve();
            bgm.pause = () => { };
        };

        // --- Game Logic ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreElement = document.getElementById('score');
        const comboElement = document.getElementById('combo');
        const levelElement = document.getElementById('level-indicator');
        const slowGaugeContainer = document.getElementById('slow-gauge-container');
        const slowGauge = document.getElementById('slow-gauge');
        const msgOverlay = document.getElementById('msg-overlay');
        const overlayScreen = document.getElementById('overlay-screen');
        const mainButton = document.getElementById('main-button');
        const playerNameInput = document.getElementById('player-name');
        const leaderboardDiv = document.getElementById('leaderboard');
        const screenTitle = document.getElementById('screen-title');

        let gameState = 'START_MENU';
        let score = 0, combo = 0, level = 1, speed = 6, distance = 0, slowTime = 0;
        let player, obstacles = [], items = [], particles = [];

        const PLAYER_SIZE = 35;
        const SLOW_DURATION = 300;

        class Player {
            constructor() {
                this.x = canvas.width / 2;
                this.y = canvas.height * 0.8;
                this.targetX = this.x;
            }
            update() { this.x += (this.targetX - this.x) * 0.25; }
            draw() {
                ctx.fillStyle = "#00f2ff";
                ctx.shadowBlur = 15; ctx.shadowColor = "#00f2ff";
                ctx.fillRect(this.x - PLAYER_SIZE / 2, this.y - PLAYER_SIZE / 2, PLAYER_SIZE, PLAYER_SIZE);
                ctx.fillStyle = "white";
                ctx.fillRect(this.x - PLAYER_SIZE / 4, this.y - PLAYER_SIZE / 4, PLAYER_SIZE / 2, PLAYER_SIZE / 2);
                ctx.shadowBlur = 0;
            }
            move(dir) {
                const lane = canvas.width / 3.5;
                if (dir === 'left') this.targetX = Math.max(PLAYER_SIZE, this.targetX - lane);
                else this.targetX = Math.min(canvas.width - PLAYER_SIZE, this.targetX + lane);
            }
        }

        class Obstacle {
            constructor() {
                this.w = canvas.width * (0.2 + Math.random() * 0.3);
                this.h = 35;
                this.x = Math.random() * (canvas.width - this.w);
                this.y = -100;
                this.passed = false;
            }
            update(s) { this.y += s; }
            draw() {
                ctx.fillStyle = "#ff00de";
                ctx.shadowBlur = 10; ctx.shadowColor = "#ff00de";
                ctx.fillRect(this.x, this.y, this.w, this.h);
                ctx.shadowBlur = 0;
            }
        }

        class Item {
            constructor(type) {
                this.type = type;
                this.size = 24;
                this.x = Math.random() * (canvas.width - this.size);
                this.y = -100;
            }
            update(s) { this.y += s * 1.2; }
            draw() {
                const glow = this.type === 'gold' ? "#ffcc00" : "#00ff88";
                ctx.fillStyle = glow;
                ctx.shadowBlur = 15; ctx.shadowColor = glow;
                ctx.fillRect(this.x, this.y, this.size, this.size);
                ctx.shadowBlur = 0;
            }
        }

        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y; this.color = color;
                this.vx = (Math.random() - 0.5) * 10; this.vy = (Math.random() - 0.5) * 10;
                this.life = 1.0;
            }
            update() { this.x += this.vx; this.y += this.vy; this.life -= 0.04; }
            draw() {
                ctx.fillStyle = this.color.replace(')', `, ${this.life})`).replace('rgb', 'rgba');
                ctx.fillRect(this.x, this.y, 3, 3);
            }
        }

        const showMsg = (txt) => {
            msgOverlay.innerText = txt;
            msgOverlay.style.animation = 'none';
            void msgOverlay.offsetWidth;
            msgOverlay.style.animation = 'popOut 1s forwards';
        };

        const saveScore = async () => {
            const name = playerNameInput.value.trim() || "GUEST";
            if (!user) return;
            try {
                const col = collection(db, 'artifacts', appId, 'public', 'data', 'scores');
                await addDoc(col, { name: name, uid: user.uid, score: Math.floor(score), date: Date.now() });
                loadRanking();
            } catch (e) { console.error("Score save error:", e); }
        };

        const loadRanking = async () => {
            const list = document.getElementById('leaderboard-list');
            try {
                const col = collection(db, 'artifacts', appId, 'public', 'data', 'scores');
                const snap = await getDocs(col);
                let results = [];
                snap.forEach(d => results.push(d.data()));
                results.sort((a, b) => b.score - a.score);
                list.innerHTML = results.slice(0, 5).map((r, i) => `
                <div class="leaderboard-entry ${r.uid === user?.uid ? 'is-me' : ''}">
                    <span>${i + 1}. ${r.name}</span>
                    <span>${r.score}</span>
                </div>
            `).join('') || "No scores yet";
            } catch (e) {
                list.innerText = "Ranking error";
            }
        };

        function update() {
            if (gameState !== 'PLAYING') {
                if (player) player.update();
                return;
            }

            let curSpeed = speed;
            if (slowTime > 0) {
                curSpeed *= 0.5;
                slowTime--;
                slowGaugeContainer.classList.add('active');
                slowGauge.style.transform = `scaleX(${slowTime / SLOW_DURATION})`;
                bgm.playbackRate = 0.8; // スロー中は曲のテンポも落とす演出
            } else {
                slowGaugeContainer.classList.remove('active');
                bgm.playbackRate = 1.0;
            }

            distance++;
            player.update();

            const targetLevel = Math.floor(score / 200) + 1;
            if (targetLevel > level) {
                level = targetLevel; speed += 0.8;
                levelElement.innerText = `LEVEL ${level}`;
                showMsg("SPEED UP!");
            }

            if (distance % Math.max(10, 45 - level) === 0) obstacles.push(new Obstacle());
            if (distance % 400 === 0) items.push(new Item('gold'));
            if (distance % 700 === 0) items.push(new Item('slow'));

            obstacles.forEach((o, i) => {
                o.update(curSpeed);
                if (player.x + 12 > o.x && player.x - 12 < o.x + o.w && player.y + 12 > o.y && player.y - 12 < o.y + o.h) endGame();
                if (!o.passed && o.y > player.y) {
                    o.passed = true;
                    const d = Math.min(Math.abs(player.x - o.x), Math.abs(player.x - (o.x + o.w)));
                    if (d < 50) {
                        combo++; score += 20 * combo;
                        comboElement.innerText = `NEAR MISS x${combo}`;
                        comboElement.classList.add('active');
                    } else { score += 10; }
                    scoreElement.innerText = score;
                }
                if (o.y > canvas.height) obstacles.splice(i, 1);
            });

            items.forEach((it, i) => {
                it.update(curSpeed);
                if (Math.hypot(player.x - it.x, player.y - it.y) < 40) {
                    items.splice(i, 1);
                    if (it.type === 'gold') { score += 500; showMsg("+500!"); }
                    else { slowTime = SLOW_DURATION; showMsg("SLOW!"); }
                    scoreElement.innerText = score;
                }
                if (it.y > canvas.height) items.splice(i, 1);
            });

            particles.forEach((p, i) => {
                p.update();
                if (p.life <= 0) particles.splice(i, 1);
            });
        }

        function draw() {
            ctx.fillStyle = 'rgba(10, 10, 12, 0.3)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            obstacles.forEach(o => o.draw());
            items.forEach(it => it.draw());
            particles.forEach(p => p.draw());
            if (player) player.draw();
        }

        function gameLoop() {
            update(); draw();
            requestAnimationFrame(gameLoop);
        }

        const start = () => {
            // BGM再生開始
            bgm.play().catch(e => console.log("Audio play prevented"));

            score = 0; level = 1; speed = 6; distance = 0; combo = 0; slowTime = 0;
            scoreElement.innerText = "0";
            levelElement.innerText = "LEVEL 1";
            comboElement.classList.remove('active');
            obstacles = []; items = []; particles = [];
            player = new Player();
            gameState = 'READY';
            overlayScreen.classList.add('hidden');
            showMsg("READY...");
            setTimeout(() => { if (gameState === 'READY') { gameState = 'PLAYING'; showMsg("GO!"); } }, 1000);
        };

        const endGame = () => {
            gameState = 'GAMEOVER';
            bgm.playbackRate = 0.5; // クラッシュ感を出すためにピッチを下げる
            screenTitle.innerText = "CRASHED";
            screenTitle.style.color = "var(--neon-pink)";
            document.getElementById('screen-subtitle').innerText = `FINAL SCORE: ${score}`;
            playerNameInput.classList.add('hidden');
            leaderboardDiv.classList.remove('hidden');
            mainButton.innerText = "RETRY";
            overlayScreen.classList.remove('hidden');
            saveScore();
        };

        const handleInput = (e) => {
            if (gameState !== 'PLAYING' && gameState !== 'READY') return;
            const x = e.touches ? e.touches[0].clientX : e.clientX;
            if (x < canvas.width / 2) player.move('left');
            else player.move('right');
        };

        window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; });
        window.addEventListener('touchstart', handleInput, { passive: false });
        window.addEventListener('mousedown', handleInput);

        mainButton.addEventListener('click', () => {
            if (gameState === 'START_MENU' || gameState === 'GAMEOVER') start();
        });

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        gameLoop();
    </script>
</body>

</html>